rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return request.auth.token.email.matches('.*@bling.is') || 
             request.auth.token.email in ['jonbs@bling.is', 'admin@bling.is', 'jon@bling.is'];
    }

    // --- Venues Collection ---
    match /venues/{venueId} {
      // Anyone can read APPROVED venues (Public)
      // Owners can read their OWN venues (even if pending)
      // Relaxed for Launch: Signed-in users can see all (for Admin Dash)
      allow read: if resource.data.status == 'approved' || isSignedIn();
      
      // Only the owner OR Admin can create/update
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (resource.data.ownerId == request.auth.uid || isAdmin());
      
      // Owner or Admin can delete
      allow delete: if isSignedIn() && (resource.data.ownerId == request.auth.uid || isAdmin());
    }

    // --- Profiles (Artists/Promoters) ---
    match /profiles/{profileId} {
      allow read: if true; // Profiles are generally public? Or only for logged in users? Let's say public for now.
      allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
      allow update: if isSignedIn() && resource.data.uid == request.auth.uid;
    }
    
    // --- Mail (For SendGrid Extension) ---
    match /mail/{mailId} {
        allow create: if isSignedIn();
    }

    // --- Users Collection ---
    match /users/{userId} {
      // Allow users to read/write their own data, OR Admins to access all
      allow read, update, delete: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow create: if isSignedIn();
    }

    // --- Bookings ---
    match /bookings/{bookingId} {
        allow create: if true; // Public guest requests allowed
        
        // Allow reading if:
        // 1. The booking is APPROVED (so calendar can block dates for everyone)
        // 2. OR You are the booker
        // 3. OR You are the venue owner
        allow read: if (resource.data.status == 'approved') || (
            isSignedIn() && (
                resource.data.bookerId == request.auth.uid || 
                resource.data.ownerId == request.auth.uid
            )
        );

        allow update, delete: if isSignedIn() && (
            resource.data.ownerId == request.auth.uid ||
            resource.data.bookerId == request.auth.uid
        );
    }
  }
}
